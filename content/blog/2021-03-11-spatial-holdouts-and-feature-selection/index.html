---
title: Spatial Holdouts and Feature Selection
author: Josh Erickson
date: '2021-03-11'
slug: []
categories: []
tags: []
description: ''
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>
<link href="{{< blogdown/postref >}}index_files/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/anchor-sections/anchor-sections.js"></script>
<script src="{{< blogdown/postref >}}index_files/htmlwidgets/htmlwidgets.js"></script>
<script src="{{< blogdown/postref >}}index_files/jquery/jquery.min.js"></script>
<link href="{{< blogdown/postref >}}index_files/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/datatables-binding/datatables.js"></script>
<link href="{{< blogdown/postref >}}index_files/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="{{< blogdown/postref >}}index_files/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/dt-core/js/jquery.dataTables.min.js"></script>
<link href="{{< blogdown/postref >}}index_files/nouislider/jquery.nouislider.min.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/nouislider/jquery.nouislider.min.js"></script>
<link href="{{< blogdown/postref >}}index_files/selectize/selectize.bootstrap3.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/selectize/selectize.min.js"></script>
<link href="{{< blogdown/postref >}}index_files/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="{{< blogdown/postref >}}index_files/crosstalk/js/crosstalk.min.js"></script>


<p><strong>Findings</strong></p>
<ul>
<li><p>Both model types (gbm and random forest) are very sensitive when using all variables and no spatial hold-outs; however, when increasing the hold out size (iid becomes more appropriate) we see that random forest takes some time before it stabilizes unlike gbm which is able to control for that effect early on.</p></li>
<li><p>FFS variable selection at cluster holdout 10 was 9 variables while the new variable selection (unnamed) used only 5 variables at a cluster holdout of 10 while keeping the same accuracy; making the model more parsimonious.</p></li>
<li><p>Difference between 10 and 100 holdout clusters is 0.001 in contrast to no holdouts (Random CV) and 10 the difference is 0.041.</p></li>
<li><p>Accuracy for GBM models: Random CV (0.88), Topoclimatic (0.839), Topography-only (0.812), NDHPlus (0.827).</p></li>
</ul>
<p><strong>Discussion</strong></p>
<ul>
<li><p>There is a lot of interesting results not only in the stream prediction part but also in the model building process. How might this be improved or communicated so that others can use to their advantage?</p></li>
<li><p>What are some possible limitations with this approach?</p></li>
<li><p>The separation between the results are not so hard-hitting but do they shed some light into the advantages of using some remote sensing indices?</p></li>
</ul>
<p>This is a exploration into picking a hold out set in the headwater stream prediction model. First read in the data and then clean it. This data includes 238 model runs (119 GBM/ 199 RF) at cluster holdouts of 5-100 and then a sequence of 101-651 by 25 along with 3 Random CV runs and two cluster of 10 tuned models for a total of 243 models. Below are plots of all these model runs and a loose interpretation in how the variables and holdout value were determined. Notice how steep the drop off is from Random CV (Holdout Cluster = 0) and 5 holdout.</p>
<p><br></p>
<p>Let’s look a little closer into the data where we have more model runs, e.g. less than 100.</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;" /><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-3-1.gif" style="display: block; margin: auto;" /></p>
<p>Now let’s look at other statistics, e.g. sensitivity, specificity, J, Kappa.</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/warning==F-1.png" width="50%" height="50%" style="display: block; margin: auto;" /></p>
<p>Now with standard deviation within each cluster.</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-1.png" width="50%" height="50%" style="display: block; margin: auto;" />
<br></p>
<p>Now let’s just look at the two models side-by-side. You can see in this graph below that random forest is really overfitting with low cluster holdouts.</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="50%" height="50%" style="display: block; margin: auto;" /></p>
<p>What’s really nice about doing a bunch of cluster holdouts with feature selection is we can see what variables show up the most between both models. This will give us a better idea of what variables to use instead of just selecting what ‘ffs’ selects. For example, sometimes the variable ‘Green’ gets selected in the ‘ffs’ but from the graph below both rf and gbm select ‘Green’ only a few times. So, if you just randomly choose a holdout (say 40) and get ‘Green’ now you will use this in further modelling which is going to be misleading.</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-6-1.png" width="50%" height="50%" style="display: block; margin: auto;" />
<br>
If you want you can sort and play with the data below.
<br>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"top","filterHTML":"<tr>\n  <td><\/td>\n  <td data-type=\"factor\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"width: 100%; display: none;\">\n      <select multiple=\"multiple\" style=\"width: 100%;\" data-options=\"[&quot;accum30&quot;,&quot;cad30RS&quot;,&quot;cpg30precip&quot;,&quot;decid30RS&quot;,&quot;deficitRS&quot;,&quot;Green_med&quot;,&quot;NDVI_med&quot;,&quot;NIR_med&quot;,&quot;npol30agg&quot;,&quot;nppmmid30agg&quot;,&quot;tpi30agg&quot;,&quot;twi30agg&quot;,&quot;vv30agg&quot;,&quot;vvsd30agg&quot;]\"><\/select>\n    <\/div>\n  <\/td>\n  <td data-type=\"factor\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"width: 100%; display: none;\">\n      <select multiple=\"multiple\" style=\"width: 100%;\" data-options=\"[&quot;gbm&quot;,&quot;rf&quot;]\"><\/select>\n    <\/div>\n  <\/td>\n  <td data-type=\"integer\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none; position: absolute; width: 200px;\">\n      <div data-min=\"9\" data-max=\"119\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28"],["accum30","accum30","nppmmid30agg","nppmmid30agg","tpi30agg","tpi30agg","deficitRS","cad30RS","deficitRS","twi30agg","vvsd30agg","NDVI_med","decid30RS","cad30RS","cpg30precip","decid30RS","twi30agg","vv30agg","NIR_med","npol30agg","NDVI_med","NIR_med","npol30agg","Green_med","vvsd30agg","vv30agg","Green_med","cpg30precip"],["gbm","rf","gbm","rf","gbm","rf","rf","rf","gbm","rf","rf","rf","gbm","gbm","rf","rf","gbm","rf","rf","rf","gbm","gbm","gbm","gbm","gbm","gbm","rf","gbm"],[119,119,119,119,116,116,106,105,104,101,86,79,76,74,66,59,57,55,52,51,34,23,23,18,14,13,10,9]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>value<\/th>\n      <th>model<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":3},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true}},"evals":[],"jsHooks":[]}</script></p>
<p>Here we can see that we need to make a decision about Deciduous, CAD (Cold Air Drainage) and TWI. We want to keep the variables that will provide the best results but while still keeping the model parsimonious. From the graphs above it’s evident that gbm is not as sensitive to spatial cluster when compared to rf. Both are very sensitive when using all variables and no spatial hold-out; however, when increasing the hold out size (iid becomes more appropriate) we see that rf takes some time before it stabilizes unlike gbm which is able to control for that effect early on. Not sure why this happens but it might be 1). random forest is sensitive to spatial data due to bootstrapping non-iid data which in turn overfits, 2). gbm by default does its own kind of feature selection (slow learners and no bootstrapping or mtry) which might help curb some of the spatial overfitting seen by random forest. Thus, we’ll use gbm from here on out to reduce the chance of overfitting.</p>
<p>Below are a couple different visualisations of how the data reacts to cluster sizes. We really want to see if there is a point at which we can ‘accept’ our model in terms of iid assumptions, i.e. has it accounted for the effects of spatial autocorrelation.</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-8-1.png" width="50%" height="50%" style="display: block; margin: auto;" /></p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-9-1.png" width="50%" height="50%" style="display: block; margin: auto;" /></p>
<p>As you can see from the graphs above the black line is at the accuracy of 10 clusters. It seems that if you go beyond the clustering of 10 you slowly decrease accuracy to a point. The point at which the accuracy increases is due to unequal size of folds in the cv. This leads to folds having around 25% of the data or more within one fold! From the graphs above, it’s clear that 10 clusters is a conservative hold out value, i.e. we could pick 20, 30, 50, 100, etc and it would be relatively the same (difference between 10 and 100 is 0.001). The important part is the contrast from no holdouts (Random CV) to the 10 cluster holdout (difference between 0 and 10 is 0.041). From this I feel confident continuing with the tuning of 10 hold outs and 5 variables (accumulation, TPI, NPP, Deficit, CAD). Below you will see the range were the ‘tuned’ 10 hold out compared with the ‘ffs’ holdout.</p>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-10-1.png" width="50%" height="50%" style="display: block; margin: auto;" /></p>
<p>As you can see, it’s the same (0.839); however, here are the variables associated with the ffs: accum30, nppmmid30agg, deficitRS, twi30agg, tpi30agg, vv30agg, decid30RS, cad30RS, NDVI_med. Hence, we dropped from 9 to 5 and kept the accuracy the same making the model more parsimonious.</p>
