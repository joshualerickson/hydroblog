---
title: Data Retrieval
author: ''
date: '2020-08-20'
slug: data-retrieval
output:
  html_document:
    highlight: tango
categories: []
tags: [https://github.com/USGS-R/dataRetrieval]
description: 'Getting that USGS data you always wanted...'
---



<p>This is a quick peek into the perks of using R and USGS package <code>dataRetrieval</code>. This package is pretty slick and has a lot of functions associated with it. We will just look into some basic functions like <code>readNWISdv</code> to get some USGS gauging data and then do some quick exploratory data analysis to using the <code>tidyverse</code>.</p>
<p>First, load the packages (or install) from the library().</p>
<pre class="r"><code>library(dataRetrieval)
library(tidyverse)</code></pre>
<p>Now we can start bringing in some river data. The dataRetrieval github page has a lot of tutorials and information regarding the package and is where I got most of the information. So, use the website tagged at the bottom for more information, but for now just find a site location number that you want to bring in.</p>
<p>The Basics.
* Site Number (e.g. location # for the station)
* Parameter Code (e.g. discharge, temp, etc.)</p>
<pre class="r"><code>#the basics
tobacco_river &lt;- readNWISdv(siteNumbers = &quot;12301250&quot;, parameterCd = &quot;00060&quot;)

names(tobacco_river)</code></pre>
<pre><code>## [1] &quot;agency_cd&quot;        &quot;site_no&quot;          &quot;Date&quot;             &quot;X_00060_00003&quot;   
## [5] &quot;X_00060_00003_cd&quot;</code></pre>
<p>You can see the ‘coded’ names are weird so we need to change name. Normally you would just use something like <code>rename</code> in tidyverse but USGS has a nice helper function to rename them for you, <code>renameNWISColumns</code>.</p>
<pre class="r"><code>tobacco_river &lt;- renameNWISColumns(tobacco_river)

names(tobacco_river)</code></pre>
<pre><code>## [1] &quot;agency_cd&quot; &quot;site_no&quot;   &quot;Date&quot;      &quot;Flow&quot;      &quot;Flow_cd&quot;</code></pre>
<p>Much better and pretty slick! Now we have a data.frame with the daily flows. Let’s take a look at the hydrograph using the <code>tidyverse</code>.</p>
<pre class="r"><code>theme_set(theme_light())
tobacco_river %&gt;% ggplot(aes(Date, Flow)) + geom_line()</code></pre>
<p><img src="/post/blog/2020-08-20-data-retrieval_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>Great we can see that there is some variation in timing, e.g. look at 2016 around November. Maybe we want to look at different days, months, or years. A way to do that easily is with the <code>lubridate</code> package. We can use tidying functions like <code>mutate</code> to create new variables like day, month, year, decade, etc. First, we need to add the old station data to this data set. Sometimes, stations get replaced or moved and subsequently get a new station ID. So, we’ll just put the old one in and voila more data.</p>
<pre class="r"><code>tobacco_river_old &lt;- readNWISdv(siteNumbers = &quot;12301300&quot;, parameterCd = &quot;00060&quot;) %&gt;% renameNWISColumns()

#now rbind
tobacco_river &lt;- rbind(tobacco_river, tobacco_river_old)</code></pre>
<p>Now we can do some data tranformation.</p>
<pre class="r"><code>library(lubridate)

tobacco_river &lt;- tobacco_river %&gt;% 
mutate(year = year(Date), month = month(Date), day = day(Date), decade = year - (year %% 10), lustrum = year - (year %% 5))</code></pre>
<p>So now we can split up the data more effectively for exploring. For example,</p>
<pre class="r"><code>tobacco_river %&gt;% filter(!decade %in% c(&quot;1950&quot;,&quot;2020&quot;)) %&gt;%
ggplot(aes(Date, Flow)) + geom_line() + facet_wrap(~decade, scales = &quot;free_x&quot;)</code></pre>
<p><img src="/post/blog/2020-08-20-data-retrieval_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Or, if we just want to look at the 80’s.</p>
<pre class="r"><code>tobacco_river %&gt;% filter(decade == &quot;1980&quot;) %&gt;% ggplot(aes(Date, Flow)) + geom_line() </code></pre>
<p><img src="/post/blog/2020-08-20-data-retrieval_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>What about overlaying decades? Well we need a x-axis that is equal to each other, e.g. 10 year chunks, but we need to ‘hack’ the date somehow… Well, first we will create a ‘month-day’ variable and then add the years a sequence (1…10). This will give us a x-axis that we can than overlay the decades on.</p>
<pre class="r"><code>tobacco_river &lt;- tobacco_river %&gt;% mutate(month_day = str_c(month,day, sep = &quot;-&quot;))

tobacco_river &lt;- tobacco_river %&gt;% group_by(decade,month)  %&gt;% mutate(month_day = str_c(str_sub(year, -1), month_day, sep = &quot;-&quot;))</code></pre>
<p>Now we can overlay each decade onto one plot.</p>
<pre class="r"><code>tobacco_river %&gt;% filter(!decade %in% c(&quot;1950&quot;,&quot;2020&quot;)) %&gt;% ggplot(aes(month_day, Flow)) + geom_line(aes(color = decade, group = decade)) + scale_color_distiller(palette = &quot;RdBu&quot;)+ theme_classic() + theme(axis.ticks = element_blank(), axis.text.x = element_blank()) + labs(x = &quot;Years-Months-Days within 10 year partitions, e.g. 1980-1989, etc.&quot;, y = &quot;Maximum Daily Discharge (cfs)&quot;, title = &quot;Looking at decades of annual discharge.&quot;)</code></pre>
<p><img src="/post/blog/2020-08-20-data-retrieval_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>Wow, really confusing and distracting! That’s why it’s always good to facet with lots of data; however, it’s always fun to maybe find some trends. Let’s just look at the maximum for each month, each year and see if there are any cool trends.</p>
<pre class="r"><code>tobacco_river %&gt;% filter(!decade %in% c(&quot;1950&quot;,&quot;2020&quot;)) %&gt;% group_by(year, month) %&gt;% slice_max(Flow) %&gt;%  ggplot(aes(month, Flow)) + geom_line(aes(color = year, group = year)) + scale_color_distiller(palette = &quot;Spectral&quot;)+ theme_classic()  + scale_x_continuous(breaks = seq(1,12,1)) + labs(x = &quot;Months&quot;, y = &quot;Maximum Monthly Discharge (cfs)&quot;, title = &quot;Looking at monthly max discharge per year.&quot;)</code></pre>
<p><img src="/post/blog/2020-08-20-data-retrieval_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>Wow, still awful! What if we did boxplot per month? Maybe this would help see the dispersion.</p>
<pre class="r"><code>tobacco_river %&gt;% filter(!decade %in% c(&quot;1950&quot;,&quot;2020&quot;)) %&gt;% group_by(year, month) %&gt;% slice_max(Flow) %&gt;%  ggplot(aes(month, Flow)) + geom_boxplot(aes(group = month)) + 
stat_summary(fun=median, geom=&quot;line&quot;, aes(group=1))  + 
stat_summary(fun=median, geom=&quot;point&quot;, color = &quot;red&quot;) + theme_classic()  + scale_x_continuous(breaks = seq(1,12,1)) + labs(x = &quot;Months&quot;, y = &quot;Maximum Monthly Discharge (cfs)&quot;, title = &quot;Looking at monthly max discharge per year.&quot;) + scale_y_continuous(labels = scales::comma_format())</code></pre>
<p><img src="/post/blog/2020-08-20-data-retrieval_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>Much better! I like this as it gives more context into the extremes of the months (i.e. outliers) and you can see the median per month which is always nice. In the next blog we’ll take this data and compare it to some precipitation data from the RGEE package. We’ll see if there are any interesting trends with the two, i.e. gauging station and PRISM. The PRISM data takes in <strong>total</strong> monthly precipitation as well so we can look at both the total discharge per month and total precipitation. The plot below show the <strong>total</strong> discharge per month per year.</p>
<p><img src="/post/blog/2020-08-20-data-retrieval_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
